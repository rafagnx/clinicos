<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/logo-clinica.png" />
  <link rel="apple-touch-icon" href="/logo-clinica.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ClinicOS" />
  <title>ClinicOS</title>
</head>
<script>
  (function () {
    try {
      // üßπ SELF HEALING: Aggressive Token Cleanup 2.0 üßπ
      // Risks: User avatar might disappear from UI until re-login, but app will work.
      // Goal: Prevent 431 Request Header Fields Too Large / ERR_CONNECTION_RESET
      console.log('üõ°Ô∏è ClinicOS: Checking auth token size...');
      var cleaned = false;

      // Deep Recursive Cleaner
      function recursiveClean(obj) {
        var modified = false;
        for (var key in obj) {
          if (typeof obj[key] === 'string' && obj[key].length > 1000) {
            console.warn('üõ°Ô∏è Stripping massive field: ' + key + ' (' + obj[key].length + ' chars)');
            obj[key] = "";
            modified = true;
          } else if (typeof obj[key] === 'object' && obj[key] !== null) {
            if (recursiveClean(obj[key])) modified = true;
          }
        }
        return modified;
      }

      for (var key in localStorage) {
        if (key.includes('supabase.auth.token') || key.includes('-auth-token') || key === 'clinicos-token') {
          var raw = localStorage.getItem(key);
          if (raw && raw.length > 8000) {
            console.log('üõ°Ô∏è Analyzing large token: ' + key + ' (' + raw.length + ' bytes)');
            try {
              var data = JSON.parse(raw);
              var wasModified = false;

              if (data && data.user) {
                if (recursiveClean(data.user)) wasModified = true;
              }

              if (wasModified) {
                localStorage.setItem(key, JSON.stringify(data));
                console.log('‚úÖ Token sanitized. New size: ' + localStorage.getItem(key).length);
                cleaned = true;
              }

              // Only nuke if truly astronomical (>32KB is definitely a bug/leak)
              var finalSize = localStorage.getItem(key).length;
              if (finalSize > 32000) {
                console.warn('‚ö†Ô∏è Token still HUGE (' + finalSize + '). Nuking.');
                localStorage.removeItem(key);
                cleaned = true;
              }
            } catch (e) {
              if (raw.length > 16000) {
                console.warn('‚ö†Ô∏è Non-JSON huge token. Deleting.');
                localStorage.removeItem(key);
                cleaned = true;
              }
            }
          }
        }
      }

      if (cleaned) {
        console.log('üîÑ Cleaning complete.');
        // window.location.reload(); 
      }
    } catch (e) {
      console.error('Shield check failed', e);
    }
  })();
</script>

<body>
  <div id="root"></div>
  <script type="module" src="/main.tsx"></script>
</body>

</html>