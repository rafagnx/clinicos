generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  image         String?
  phone         String?
  specialty     String?
  emailVerified Boolean?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  memberships   Member[]
  notifications Notification[]
  
  // Scoped data
  notificationPreferences NotificationPreference[]

  @@map("user")
}

model Organization {
  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  logo               String?
  subscriptionStatus String?  @map("subscription_status")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  members              Member[]
  patients             Patient[]
  professionals        Professional[]
  appointments         Appointment[]
  notifications        Notification[]
  leads                Lead[]
  financialTransactions FinancialTransaction[]
  medicalRecords       MedicalRecord[]
  messages             Message[]
  conversations        Conversation[]
  clinicSettings       ClinicSetting[]
  procedureTypes       ProcedureType[]
  promotions           Promotion[]
  pendingInvites       PendingInvite[]
  notificationPreferences NotificationPreference[]
  
  // WhatsApp / Evolution API Config
  evolutionInstanceName String? @map("evolution_instance_name")
  evolutionToken        String? @map("evolution_token")
  evolutionBaseUrl      String? @default("https://api.evolution-api.com") @map("evolution_base_url")
  whatsappTemplates     Json?   @map("whatsapp_templates")
  campaigns             Campaign[]
  treatmentPlans        TreatmentPlan[]

  @@map("organization")
}

model Member {
  id             String       @id @default(uuid())
  organizationId String
  userId         String
  role           String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("member")
}

model Patient {
  id              Int      @id @default(autoincrement())
  organizationId  String?  @map("organization_id")
  name            String
  email           String?
  phone           String?
  cpf             String?
  birthDate       DateTime? @map("birth_date") @db.Date
  photoUrl        String?  @map("photo_url")
  whatsapp        String?
  gender          String?
  address         String?
  city            String?
  marketingSource String?  @map("marketing_source")
  notes           String?
  status          String?  @default("ativo")
  deleted         Boolean  @default(false)
  createdAt       DateTime @default(now()) @map("created_at")

  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  appointments    Appointment[]
  medicalRecords  MedicalRecord[]
  treatmentPlans  TreatmentPlan[]

  @@map("patients")
}

model Professional {
  id                  Int      @id @default(autoincrement())
  organizationId      String?  @map("organization_id")
  name                String
  email               String?  @unique
  status              String?  @default("ativo")
  roleType            String?  @default("profissional") @map("role_type")
  councilNumber       String?  @map("council_number")
  councilState        String?  @map("council_state")
  phone               String?
  specialty           String?
  color               String?  @default("#3B82F6")
  appointmentDuration Int?     @default(30) @map("appointment_duration")
  photoUrl            String?  @map("photo_url")
  createdAt           DateTime @default(now()) @map("created_at")

  organization        Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  appointments        Appointment[]
  treatmentPlanItems  TreatmentPlanItem[]

  @@map("professionals")
}

model Appointment {
  id             Int      @id @default(autoincrement())
  organizationId String?  @map("organization_id")
  patientId      Int?     @map("patient_id")
  professionalId Int?     @map("professional_id")
  procedureName  String?  @map("procedure_name")
  startTime      DateTime @map("start_time")
  endTime        DateTime @map("end_time")
  duration       Int?     @default(60)
  scheduledBy    String?  @map("scheduled_by")
  promotionId    String?  @map("promotion_id") @db.Uuid
  date           DateTime? @db.Date // Legacy/Redundant if we have start_time? Keeping for compatibility
  time           String?
  status         String?  @default("scheduled")
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patient        Patient?      @relation(fields: [patientId], references: [id])
  professional   Professional? @relation(fields: [professionalId], references: [id])

  @@map("appointments")
}

model Notification {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String?  @map("organization_id")
  userId         String   @map("user_id")
  title          String?
  message        String?
  read           Boolean? @default(false)
  actionUrl      String?  @map("action_url")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @map("updated_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model PendingInvite {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id")
  email          String
  role           String?  @default("member")
  token          String?  @unique
  accepted       Boolean  @default(false)
  createdBy      String?  @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("pending_invites")
}

// --------------------------------------------------------------------------
// Placeholder models for entities referenced in server/index.js generic CRUD
// --------------------------------------------------------------------------

model Lead {
  id             Int      @id @default(autoincrement())
  organizationId String?  @map("organization_id")
  name           String?
  status         String?
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  @@map("leads")
}

model FinancialTransaction {
  id             Int      @id @default(autoincrement())
  organizationId String?  @map("organization_id")
  amount         Decimal?
  description    String?
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  @@map("financial_transactions")
}

model MedicalRecord {
  id             Int      @id @default(autoincrement())
  organizationId String?  @map("organization_id")
  patientId      Int?     @map("patient_id")
  content        String?
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patient        Patient?      @relation(fields: [patientId], references: [id])
  @@map("medical_records")
}

model Message {
  id             Int      @id @default(autoincrement())
  organizationId String?  @map("organization_id")
  content        String?
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  @@map("messages")
}

model Conversation {
  id             Int      @id @default(autoincrement())
  organizationId String?  @map("organization_id")
  title          String?
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  @@map("conversations")
}

model ClinicSetting {
  id             Int      @id @default(autoincrement())
  organizationId String?  @map("organization_id")
  key            String?
  value          String?
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  @@map("clinic_settings")
}

model ProcedureType {
  id             Int      @id @default(autoincrement())
  organizationId String?  @map("organization_id")
  name           String?
  durationMinutes Int?    @map("duration_minutes")
  price          Decimal?
  color          String?
  returnInterval Int?     @map("return_interval") // Logic: days to recall (e.g., 90 for 3 months)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  @@map("procedure_types")
}

model Promotion {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String?  @map("organization_id")
  name           String?
  code           String?
  discount       Decimal?
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  @@map("promotions")
}

model NotificationPreference {
  id                    Int      @id @default(autoincrement())
  organizationId        String?  @map("organization_id")
  userId                String   @map("user_id")
  emailEnabled          Boolean? @default(true) @map("email_enabled")
  pushEnabled           Boolean? @default(true) @map("push_enabled")
  whatsappEnabled       Boolean? @default(false) @map("whatsapp_enabled")
  appointmentReminders  Boolean? @default(true) @map("appointment_reminders")
  marketingUpdates      Boolean? @default(false) @map("marketing_updates")
  createdAt             DateTime @default(now()) @map("created_at")

  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("notification_preferences")
}

model TreatmentPlan {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String   @map("organization_id")
  patientId       Int      @map("patient_id")
  name            String
  description     String?
  totalValue      Decimal? @map("total_value")
  status          String?  @default("orcamento") // orcamento, aprovado, concluido, cancelado
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @map("updated_at")

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patient         Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  items           TreatmentPlanItem[]
  
  @@map("treatment_plans")
}

model Campaign {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String   @map("organization_id")
  name            String
  type            String   // aniversario, retorno_90d, pos_consulta, custom
  triggerCondition String? @map("trigger_condition") // JSON or specific condition
  messageTemplate String   @map("message_template")
  isActive        Boolean  @default(false) @map("is_active")
  lastRun         DateTime? @map("last_run")
  stats           Json?    @default("{}") // {sent: 0, opened: 0}
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @map("updated_at")

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("campaigns")
}

model TreatmentPlanItem {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  planId          String   @map("plan_id") @db.Uuid
  procedureName   String   @map("procedure_name")
  quantity        Int      @default(1)
  unitPrice       Decimal? @map("unit_price")
  totalPrice      Decimal? @map("total_price")
  status          String?  @default("pendente") // pendente, realizado
  performedAt     DateTime? @map("performed_at")
  professionalId  Int?     @map("professional_id")
  createdAt       DateTime @default(now()) @map("created_at")

  plan            TreatmentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  professional    Professional? @relation(fields: [professionalId], references: [id])
  
  @@map("treatment_plan_items")
}
